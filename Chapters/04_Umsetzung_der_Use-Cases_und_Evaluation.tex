\chapter{Umsetzung der Use-Cases und Evaluation} \label{Umsetzung der Use-Cases und Evaluation}

\section{Use-Case 1: Basis Deployment} \label{Use-Case 1: Basis Deployment}
%IPAM-Vorbereitungen, TF Matching erläutern
%Was ist ein Subnet im Cloud-Kontext? Einleitung?
%TF: Resource, Data, Modul, Provider
\subsection{Umsetzung: Kerntätigkeiten}

Im PHPIPAM müssen mehrere Netzbereiche reserviert werden. Es werden Netzbereiche benötigt, in denen Maschinen per IPv4 kommunizieren können. Diese Netze werden mit VPC bzw. VNET assoziiert. Für VNET wurde der Netzblock \glqq 10.32.0.0/16\grqq{} und für VPC der Netzblock \glqq 10.33.0.0/16\grqq{} vorreserviert, aus dem kleinere {Subnets} für die jeweilige Cloud entnommen werden können. Weiterhin ist die Annahme, dass die Private Cloud bereits einen Netzbereich besitzt, in dem Maschinen angesiedelt sind: \glqq 192.168.201.0/24.\grgg{}\\
%https://docs.aws.amazon.com/vpn/latest/s2svpn/VPNTunnels.html
%https://docs.microsoft.com/de-de/azure/vpn-gateway/bgp-howto
Weiterhin benötigt man {Transfernetzwerke}, über die die IPv4-Pakete geschickt werden und die BGP-Präfixe ausgetauscht werden können. AWS sieht hierfür /30-Präfixe aus dem Bereich \glqq 169.254.0.0/16\grqq{} vor, Azure hat eine Range reserviert: \glqq 169.254.21.0 - 169.254.22.255\grqq{}. Als Kompromiss können daher nur Netze aus den Azure-Bereichen genutzt werden, da die Bereiche, die AWS zur Verfügung stellt, größtenteils außerhalb dieser Range liegen. Auch diese Netzbereiche müssen im IPAM vorreserviert werden, auch die Transfernetze automatisiert ausgebracht werden.\\
Im folgenden Code-Beispiel wird innerhalb des IPAM nach dem Bereich \glqq TF\_CLOUD\_BGP\_TRANSFER\grqq{}, aus dem alle Transfernetze entommen werden, gesucht. Innerhalb des Bereichs wird aus dem vorreservierten Block \glqq Cloud\_Transfer\_BGP\_1\grqq{} ein /30-Netzwerk entnommen. Die Reservierung der Netzblöcke für VPC und VNET erfolgen analog.
%data vs. resource in Einleitung erläutern?
\begin{lstlisting}[label=network-reservation-ip,caption=Die data-Anweisungen dienen ausschließlich der Suche nach dem passenden Transfernetzwerk-Block. Per resource-Anweisung wird ein /30-Netzwerk reserviert.]
//Azure - AWS Transfer
data "phpipam_section" "apipa_main_section" {
  name = "TF_CLOUD_BGP_TRANSFER"
}
data "phpipam_subnet" "apipa_transfer_subnet" {
  section_id = data.phpipam_section.apipa_main_section.section_id
  description_match = "Cloud_Transfer_BGP_1"
} 
resource "phpipam_first_free_subnet" "free_subnet_apipa" {
  parent_subnet_id = data.phpipam_subnet.apipa_transfer_subnet.subnet_id
  subnet_mask = 30
  description = "BGP_AWS_AZURE"
}
\end{lstlisting}

Es ist auch möglich, dass IPv4-Adressen für Transfernetze automatisch von Azure bzw. AWS vorgegeben werden. Mit dem avisierten Backbone-Design aus drei Teilnehmern lässt sich das allerdings nicht vereinbaren: die Adressbereiche müssen vom IPAM vorgegeben werden (vgl. später: Probleme statische Route).\\
Weiterhin werden Pre-Shared-Keys für die Aushandlung der IPSEC-Verbindungen benötigt. AWS erzeugt automatisch solche Schlüssel, welche durch das Terraform-Modul \glqq aws\_vpn\_connection\grqq{} zurückgegeben werden. Diese automatisch erzeugten Schlüssel werden daher für die Backbone-Verbindungen AWS <-> Azure und AWS <-> Private Cloud (VyOS) genutzt. Da Azure diese Schlüssel nicht erzeugt, wurde ein Terraform-Modul geschrieben, welches diese Schlüssel aus 24 Zeichen erzeugt. Dieses kann anschließend genutzt werden für die Backbone-Verbindung Azure <-> Private Cloud (VyOS).

\begin{lstlisting}[label=tf-generate-psk,caption=Auf Sonderzeichen (special) wurde verzichtet. Das Modul stellt per output-Anweisung den Schlüssel für andere Terraform-Module zur Verfügung.]
resource "random_password" "random_password" {
  length = 24
  lower = true
  upper = true
  number = true
  special = false
}
output "azure_vyos_tunnel1_psk" {
  value = random_password.random_password.result
  sensitive = true
}
\end{lstlisting}

%alles Devices nennen?
Da, wie bereits erwähnt (vgl. klick), für die VyOS-Router keine Terraform-Integration verfügbar ist, wurde zur Konfiguration des Devices eine Vorlage erstellt.

%https://www.terraform.io/docs/language/functions/templatefile.html
Die Erzeugung der Vorlage erfolgt über die Funktion templatefile().

\begin{lstlisting}[label=tf-call-tpl-generation,caption=Die Funktion templatefile() erzeugt aus einer Template-Datei (vyos\_config.tpl) die Datei /tmp/example.sh. Die Template-Datei wird mit den Variablen var.aws\_vgw\_ip und aws\_tunnel1\_psk befüllt.]
resource "local_file" "vyos_config" {
  filename = /tmp/example.sh
  content = templatefile("${path.module}/include/vyos_config.tpl",
  {
    aws_vgw_ip = var.aws_vgw_ip
    aws_tunnel1_psk = var.aws_tunnel1_psk
    [ ... weitere Aufrufparameter ...]
  })
}
\end{lstlisting}


\begin{lstlisting}[label=tf-generate-tpl,caption=Verschiede set-Kommandos werden in ein VyOS-Skript eingebettet (Interpreter: /bin/vbash). Die Variablen in Zeilen 9-12 resultieren aus dem Funktionsaufruf (s.o.).]
$ head -n 11 < vyos/include/vyos_config.tpl
#!/bin/vbash
source /opt/vyatta/etc/functions/script-template
configure
#AWS
set vpn ipsec ike-group AWS lifetime '28800'
set vpn ipsec ike-group AWS proposal 1 dh-group '2'
set vpn ipsec ike-group AWS proposal 1 encryption 'aes128'
set vpn ipsec ike-group AWS proposal 1 hash 'sha1'
set vpn ipsec site-to-site peer ${aws_vgw_ip} authentication mode 'pre-shared-secret'
set vpn ipsec site-to-site peer ${aws_vgw_ip} authentication pre-shared-secret ${aws_tunnel1_psk}
set vpn ipsec site-to-site peer ${aws_vgw_ip} description 'VPC tunnel 1'
\end{lstlisting}

\begin{lstlisting}[label=tf-generate-psk,caption=Das so generierte Shell-Skript wird per SSH auf das Zielsystem (VyOS-Router) hochgeladen und per provisioner remote-exec ausgeführt.]
resource "null_resource" "vyos_config" {
  connection {
    type = "ssh"
    host = var.vyos_host
    user = var.ssh_user
    private_key = file(var.private_key_file)
  }
  provisioner "file" {
   source = /tmp/example.sh
   destination = var.vyos_script_path
  }
  provisioner "remote-exec" {
    inline = [ "chmod +x ${var.vyos_script_path}", var.vyos_script_path ]
  }
}
\end{lstlisting}

Nach dem erfolgreichen Deployment wird folgender Status von Terraform zurückgemeldet:
\begin{lstlisting}[label=tf-base-deployment-ok,caption=Terraform Deployment Status]
BLIBLABLUB
\end{lstlisting}

\begin{lstlisting}[label=tf-base-deployment-ipsec-ok,caption=IPSEC Status]
vyos@vyos-cloud:~$ show vpn ipsec sa
Connection                      State    Uptime    Bytes In/Out    Packets In/Out    Remote address    Remote ID    Proposal
------------------------------  -------  --------  --------------  ----------------  ----------------  -----------  ----------------------------------
peer-18.158.151.142-tunnel-vti  up       24s       1K/3K           19/44             18.158.151.142    N/A          AES_CBC_128/HMAC_SHA1_96/MODP_1024
peer-20.67.177.217-tunnel-vti   up       24s       652B/223B       4/3               20.67.177.217     N/A          AES_CBC_256/HMAC_SHA1_96
peer-20.67.177.217-tunnel-vti   up       24s       1K/132B         17/3              20.67.177.217     N/A          AES_CBC_256/HMAC_SHA1_96/MODP_1024
\end{lstlisting}


Außerdem wurden auf dem Cloud-Router die AWS- und Azure-Präfixe via BGP installiert. Pro Präfix sind zwei Pfade vorhanden:

\begin{lstlisting}[label=tf-base-deployment-bgp-ok,caption=BGP Status]
vyos@vyos-cloud:~$ sh ip bgp | grep -A1 -E '10.3[2|3]'
*  10.32.0.0/16     169.254.53.1           100             0 65516 65515 i
*>                  169.254.21.6                           0 65515 i
*  10.33.0.0/24     169.254.21.6                           0 65515 65516 i
*>                  169.254.53.1           100             0 65516 i
\end{lstlisting}

Hier sind auch die ersten Unterschiede zwischen den beiden Cloud-Plattformen zu erkennen: Während AWS den kompletten VPC CIDR-Block per BGP bekannt macht (/16), passiert das bei Azure nur für die Subnets, die dem VNET Address space entnommen wurden.
%Probleme: Race Condition externe IP, Redeploy wegen TF Bug, statische Route zu BGP Neighbor (Azure - AWS: Pseudo directly, Azure - VyOS: Static, Azure - AWS), stateless VyOS Config
\subsection{Probleme und Lösungsfindung}

%Härtung IPSEC Parameter? GCM usw...

\section{Use-Case 2: Road Warrior} \label{Use-Case 2: Road Warrior}

\section{Use-Case 3: Server-zu-Server} \label{Use-Case 3: Server-zu-Server}

